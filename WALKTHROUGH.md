# Explorer Notes - Extension Walkthrough

## What It Does

Explorer Notes is a VS Code extension that adds a **"Notes"** panel to the Explorer sidebar. It lets you create, open, rename, duplicate, sort, search, and delete Markdown notes — all from within VS Code. Notes are stored globally (not per-workspace), so they're shared across all VS Code windows.

Since notes are Markdown files, you get full Markdown support: formatting, headings, lists, code blocks, and — importantly — **image paste support**. You can paste an image from your clipboard directly into a note and VS Code will save it and insert the Markdown image reference automatically.

---

## Project Structure

```
explorer-notes/
├── src/
│   ├── extension.ts       # Entry point — activation, command registration, file watcher
│   ├── notesProvider.ts   # Tree data provider — lists notes, handles all operations
│   └── noteItem.ts        # Tree item — represents a single note in the sidebar
├── out/                   # Compiled JavaScript (generated by tsc)
├── package.json           # Extension manifest — commands, views, menus, settings
├── tsconfig.json          # TypeScript configuration
└── .vscode/
    ├── launch.json        # F5 debug configuration
    └── tasks.json         # Build tasks
```

---

## File-by-File Breakdown

### package.json — The Extension Manifest

This is the most important file for any VS Code extension. It declares everything the extension contributes to the editor.

**Identity:**
- `name`: `explorer-notes` — the extension ID
- `publisher`: `albin` — combined with name, gives the full ID `albin.explorer-notes`
- `main`: `./out/extension.js` — the compiled entry point VS Code loads

**Views (lines 14-21):**
```json
"views": {
  "explorer": [{
    "id": "explorerNotes",
    "name": "Notes"
  }]
}
```
This registers a new tree view called "Notes" inside the Explorer sidebar. The `id` (`explorerNotes`) is used throughout the code to reference this view.

**Welcome View (lines 23-27):**
```json
"viewsWelcome": [{
  "view": "explorerNotes",
  "contents": "No notes yet.\n[Create Note](command:explorerNotes.createNote)"
}]
```
When the notes list is empty, this message is shown with a clickable link to create the first note.

**Commands (lines 29-89):**
Eleven commands are registered:

| Command | Icon | Description |
|---------|------|-------------|
| `explorerNotes.createNote` | `$(add)` | Create a new note |
| `explorerNotes.renameNote` | `$(edit)` | Rename an existing note |
| `explorerNotes.deleteNote` | `$(trash)` | Delete a note |
| `explorerNotes.duplicateNote` | — | Duplicate a note with its content |
| `explorerNotes.revealInFinder` | — | Open Finder with the note selected |
| `explorerNotes.openNote` | `$(search)` | Quick Open — search and open a note |
| `explorerNotes.sortNameAsc` | — | Sort notes A→Z |
| `explorerNotes.sortNameDesc` | — | Sort notes Z→A |
| `explorerNotes.sortDateAsc` | — | Sort notes oldest first |
| `explorerNotes.sortDateDesc` | — | Sort notes newest first |
| `explorerNotes.refreshNotes` | `$(refresh)` | Manually refresh the note list |

**Menus (lines 91-155):**

*Title bar (`view/title`):*
- The "+" (create) and refresh buttons appear as icons in the Notes panel's title bar (`navigation` group).
- Sort options appear in the "..." overflow menu (`1_sort` group). Smart `when` clauses ensure only 2 sort items are visible at a time — the toggle for the current sort direction, and a switch to the other sort field.

*Right-click context menu (`view/item/context`):*
- **Inline icons**: Rename (pencil) and Delete (trash) appear directly on each note row.
- **Context menu** (right-click):
  - `1_actions` group: Duplicate Note, Rename Note
  - `2_danger` group: Delete Note (separated for safety)
  - `3_other` group: Reveal in Finder

All context menu items use `when: "view == explorerNotes && viewItem == note"` to only appear on note items.

**Configuration Defaults (lines 157-162):**
```json
"configurationDefaults": {
  "[markdown]": {
    "editor.pasteAs.enabled": true,
    "editor.pasteAs.preferences": ["text.markdown.image.attachment"]
  }
}
```
This enables image paste support in Markdown files. When you paste an image from your clipboard, VS Code automatically saves the image file and inserts `![alt](image.png)` instead of pasting plain text.

---

### extension.ts — The Entry Point

This is the first code VS Code runs when the extension activates.

**`activate(context)` (line 4):**

1. **Gets the storage directory (line 5):**
   ```typescript
   const notesDir = context.globalStorageUri;
   ```
   `globalStorageUri` points to a directory managed by VS Code, specific to this extension. On macOS this is:
   ```
   ~/Library/Application Support/Cursor/User/globalStorage/albin.explorer-notes/
   ```
   This is global — shared across all workspaces and windows.

2. **Creates the tree data provider (line 6):**
   ```typescript
   const notesProvider = new NotesProvider(notesDir);
   ```
   The `NotesProvider` is responsible for listing notes and performing all operations.

3. **Sets the initial sort context (line 8):**
   ```typescript
   vscode.commands.executeCommand('setContext', 'explorerNotes.sort', 'name-asc');
   ```
   This sets a VS Code context key used by `when` clauses in the menus to control which sort options are visible. Default is alphabetical A→Z.

4. **Creates the tree view (lines 10-13):**
   ```typescript
   const treeView = vscode.window.createTreeView('explorerNotes', {
     treeDataProvider: notesProvider,
     showCollapseAll: false,
   });
   ```
   Connects the `explorerNotes` view (declared in `package.json`) to our data provider. `showCollapseAll: false` because our tree is flat (no nested items).

5. **Registers commands (lines 15-57):**
   Each command from `package.json` is wired to a method on `NotesProvider`:
   - `explorerNotes.createNote` → `notesProvider.createNote()`
   - `explorerNotes.deleteNote` → `notesProvider.deleteNote(item)`
   - `explorerNotes.renameNote` → `notesProvider.renameNote(item)`
   - `explorerNotes.duplicateNote` → `notesProvider.duplicateNote(item)`
   - `explorerNotes.revealInFinder` → `notesProvider.revealInFinder(item)`
   - `explorerNotes.openNote` → `notesProvider.openNote()`
   - `explorerNotes.sortNameAsc` → `notesProvider.setSort('name-asc')`
   - `explorerNotes.sortNameDesc` → `notesProvider.setSort('name-desc')`
   - `explorerNotes.sortDateAsc` → `notesProvider.setSort('date-asc')`
   - `explorerNotes.sortDateDesc` → `notesProvider.setSort('date-desc')`
   - `explorerNotes.refreshNotes` → `notesProvider.refresh()`

   The `item` parameter comes from VS Code — when you click a button on a tree item, VS Code passes the corresponding `NoteItem` instance.

6. **Sets up a file system watcher (lines 59-63):**
   ```typescript
   const notesPattern = new vscode.RelativePattern(notesDir, '*.md');
   const watcher = vscode.workspace.createFileSystemWatcher(notesPattern);
   ```
   Watches for `*.md` file changes in the notes directory. If a file is created, deleted, or modified outside of the extension, the tree view auto-refreshes.

7. **Registers disposables (line 65):**
   All resources are pushed to `context.subscriptions` so VS Code cleans them up when the extension is deactivated.

**`deactivate()` (line 68):**
Empty — no cleanup needed beyond what the subscriptions handle.

---

### notesProvider.ts — The Core Logic

This is where all the note management happens. It implements `TreeDataProvider<NoteItem>`, which is the interface VS Code uses to populate tree views.

**Type and class properties (lines 5-10):**
```typescript
export type SortKey = 'name-asc' | 'name-desc' | 'date-asc' | 'date-desc';
```
Defines the four possible sort states. The `sortKey` property tracks the current sort mode, defaulting to `'name-asc'`.

**`constructor(private notesDir: vscode.Uri)` (line 12):**
Stores the global storage URI where all notes live.

**`setSort(key)` (lines 14-18):**
Updates the sort mode, sets the VS Code context key (so menu `when` clauses react), and refreshes the tree.

**`refresh()` (lines 20-22):**
Fires the `onDidChangeTreeData` event, causing VS Code to call `getChildren()` again and re-render the tree.

**`getTreeItem(element)` (lines 24-26):**
Required by `TreeDataProvider`. Returns the `NoteItem` as-is since it already extends `TreeItem`.

**`getChildren(element?)` (lines 28-60):**
This is where the note list is built:
1. If `element` is provided, return `[]` (flat tree, no nesting).
2. Read the notes directory and filter for `.md` files.
3. For each file, `stat()` it to get the creation time (`ctime`).
4. Create `NoteItem` instances with both the URI and `ctime`.
5. Sort based on the current `sortKey`:
   - `name-asc`: A→Z alphabetical
   - `name-desc`: Z→A alphabetical
   - `date-asc`: oldest first
   - `date-desc`: newest first
6. If the directory doesn't exist yet, the `catch` returns an empty array.

**`createNote()` (lines 62-98):**
1. Shows an input box asking for the note name, with validation (no empty names, no invalid filesystem characters like `/\:*?"<>|`).
2. Strips `.md` if the user typed it.
3. Ensures the notes directory exists with `createDirectory()`.
4. If a file with that name already exists, auto-increments: `note.md` → `note (1).md` → `note (2).md`, etc.
5. Writes an empty file.
6. Refreshes the tree.
7. Opens the new note in the editor.

**`fileExists(uri)` (lines 100-107):**
Private helper — tries to `stat()` a URI. Returns `true` if the file exists, `false` otherwise. Used by `createNote()` and `duplicateNote()` for auto-incrementing filenames.

**`renameNote(item)` (lines 109-142):**
1. Extracts the current name (without `.md` extension) using `path.basename()`.
2. Shows an input box pre-filled with the current name.
3. If the user enters the same name or cancels, does nothing.
4. Checks if the new name already exists. If so, shows a warning and aborts.
5. Renames the file using `vscode.workspace.fs.rename()`.
6. Refreshes the tree.

**`duplicateNote(item)` (lines 144-159):**
1. Creates a copy named `<original> - copy.md`.
2. If that name exists, auto-increments: `- copy (1).md`, `- copy (2).md`, etc.
3. Reads the original file's content and writes it to the new file.
4. Refreshes the tree.

**`openNote()` (lines 161-189):**
Quick Open for notes:
1. Reads all `.md` files from the notes directory.
2. If no notes exist, shows an informational message.
3. Opens a `showQuickPick` with all note filenames.
4. The user can type to filter, then press Enter to open the selected note.
5. Accessible via Command Palette: "Explorer Notes: Open Note".

**`revealInFinder(item)` (lines 191-193):**
Delegates to VS Code's built-in `revealFileInOS` command, which opens Finder (macOS) or File Explorer (Windows) with the note file selected.

**`deleteNote(item)` (lines 195-208):**
1. Shows a modal warning dialog: `Delete note "filename"?` with a "Delete" button.
2. If confirmed, deletes the file with `vscode.workspace.fs.delete()`.
3. Refreshes the tree.

---

### noteItem.ts — The Tree Item

Represents a single note in the sidebar tree.

**Constructor (lines 5-27):**
```typescript
constructor(
  public readonly noteUri: vscode.Uri,
  public readonly ctime: number,
)
```
- `noteUri` — stored as a public property so commands (delete, rename, duplicate, reveal) can access the file path.
- `ctime` — the file's creation timestamp, stored publicly so the sort logic in `getChildren()` can compare dates.

**Label and tooltip:**
- The label (displayed text) is the filename extracted via `path.basename()`.
- The tooltip shows the creation date (`Created: dd-mm-yy`) and the full file path, visible on hover.

**Other properties:**
- `contextValue`: `'note'` — this is what the `when` clauses in `package.json` menus match against (`viewItem == note`), controlling which buttons and context menu items appear.
- `command`: Clicking the item runs `vscode.open` to open the Markdown file in the editor.
- `iconPath`: Uses the built-in `markdown` theme icon.
- `collapsibleState`: `None` — notes are leaf items, not expandable.

---

## How It All Connects

```
User clicks "+" button
        │
        ▼
package.json menu ──► explorerNotes.createNote command
        │
        ▼
extension.ts ──► notesProvider.createNote()
        │
        ▼
notesProvider.ts:
  1. Show input box
  2. Auto-increment filename if duplicate
  3. Write empty .md file to globalStorageUri
  4. Call refresh() ──► fires onDidChangeTreeData
  5. Open file in editor      │
                              ▼
                    VS Code calls getChildren()
                              │
                              ▼
                    Read directory, stat each file for ctime
                              │
                              ▼
                    Sort by current sortKey
                              │
                              ▼
                    Return NoteItem[] ──► tree re-renders
```

---

## Storage Location

Notes are stored in VS Code's global extension storage:

```
~/Library/Application Support/Cursor/User/globalStorage/albin.explorer-notes/
├── meeting notes.md
├── todo.md
├── todo (1).md
└── (any pasted images end up here too)
```

This means:
- Notes are shared across all VS Code windows and workspaces.
- Notes don't pollute your project folders.
- Notes persist even if you close/reopen VS Code.
- Notes are not synced via VS Code Settings Sync (they live in local storage only).

---

## Commands Summary

| Command | Trigger | What it does |
|---------|---------|-------------|
| `explorerNotes.createNote` | "+" button in panel title, welcome view link, command palette | Prompts for name, creates `<name>.md` (auto-increments duplicates), opens it |
| `explorerNotes.openNote` | Command palette: "Explorer Notes: Open Note" | Quick Pick search — filter notes by name, open on Enter |
| `explorerNotes.renameNote` | Pencil icon on note row, right-click → Rename Note | Prompts for new name, renames the file |
| `explorerNotes.duplicateNote` | Right-click → Duplicate Note | Copies note content to `<name> - copy.md` |
| `explorerNotes.deleteNote` | Trash icon on note row, right-click → Delete Note | Confirms via modal dialog, deletes the file |
| `explorerNotes.revealInFinder` | Right-click → Reveal in Finder | Opens Finder with the note file selected |
| `explorerNotes.sortNameAsc` | "..." menu → Sort by Name (A→Z) | Sorts alphabetically ascending |
| `explorerNotes.sortNameDesc` | "..." menu → Sort by Name (Z→A) | Sorts alphabetically descending |
| `explorerNotes.sortDateDesc` | "..." menu → Sort by Date (Newest) | Sorts by creation date, newest first |
| `explorerNotes.sortDateAsc` | "..." menu → Sort by Date (Oldest) | Sorts by creation date, oldest first |
| `explorerNotes.refreshNotes` | Refresh button in panel title | Re-reads the directory and updates the tree |

---

## Sorting

The extension supports four sort modes, controlled via the "..." overflow menu in the Notes panel header:

| Sort Mode | Description |
|-----------|-------------|
| **Name A→Z** | Alphabetical ascending (default) |
| **Name Z→A** | Alphabetical descending |
| **Date Newest** | Most recently created first |
| **Date Oldest** | Oldest created first |

The menu uses smart `when` clauses with a context key (`explorerNotes.sort`). At any time, exactly 2 sort options are shown:
- A **toggle** for the current sort field (e.g., if sorting A→Z, shows "Sort by Name Z→A")
- A **switch** to the other sort field (e.g., shows "Sort by Date (Newest)")

The sort state is kept in memory and resets to Name A→Z when VS Code restarts.

---

## Right-Click Context Menu

Right-clicking a note shows a context menu with grouped actions:

```
┌─────────────────────┐
│ Duplicate Note       │  ← 1_actions group
│ Rename Note          │
│─────────────────────│
│ Delete Note          │  ← 2_danger group (separated for safety)
│─────────────────────│
│ Reveal in Finder     │  ← 3_other group
└─────────────────────┘
```

The rename and delete actions also appear as inline icons (pencil and trash) directly on each note row for quick access.

---

## Image Support

The extension configures VS Code to default to image attachment mode for Markdown files:

```json
"configurationDefaults": {
  "[markdown]": {
    "editor.pasteAs.enabled": true,
    "editor.pasteAs.preferences": ["text.markdown.image.attachment"]
  }
}
```

When you copy an image to your clipboard and paste it into a note:
1. VS Code intercepts the paste.
2. Saves the image as a file in the same directory as the note.
3. Inserts `![alt](image-filename.png)` at the cursor.
4. Use `Cmd+Shift+V` to open the Markdown preview and see the rendered image.

---

## Quick Open

The "Explorer Notes: Open Note" command (`Cmd+Shift+P` → type "Open Note") opens a Quick Pick dialog:

1. Lists all notes alphabetically.
2. Type to filter by filename.
3. Press Enter to open the selected note.
4. Press Escape to cancel.

This is useful when you have many notes and want to jump to one quickly without scrolling through the sidebar.
